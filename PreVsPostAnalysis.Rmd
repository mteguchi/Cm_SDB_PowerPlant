---
title: "Compare pre vs. post periods"
output: html_notebook
---

This file contains code to compare pre and post periods by randomly extracting the same number of individuals as the pre period from the post period without replacement and compare the calculated HR areas. It also looks at the northern most latitude of 95% and 50% UDs.

```{r}
rm(list = ls())

#library(readxl)
library(dplyr)
library(adehabitatHR)
library(rgdal)
library(leaflet) 
library(ggplot2)
library(lubridate)
library(tidyverse)
library(ggridges)

ifelse(Sys.info()[1] == 'Linux',
       source('~/Documents/R/tools/TomosFunctions.R'),
       source('~/R/tools/TomosFunctions.R'))

run.date <- "2018-09-24"
run.date2 <- "2018-09-24"

# internet <- F #TRUE
# save.figure <- T

# Minimum number of relocations per individual to be included in HR analysis
min_n <- 50
#N.end <- 32.69   # approx Coronado bridge
N.end <- 32.66 # changed from 32.69 because 152314 had a gap in data points between ~32.65 and ~32.66 - seems like there was a different behavior south and north of 32.66

source("HR_analysis_fcns.R")
tagprj <- readOGR(dsn = "Tag_065_UTMzone11n", 
                  layer = "tag_065_project")
tagproj <- proj4string(tagprj)

```

Load results from HR_analysis_GPS_LC_newtags_11July2018.Rmd. The following files contain raw data for pre and post periods.

```{r}
post.all <- read.csv("data/Post_GPS_LC_all_2018-09-18.csv")
pre.all <- read.csv("data/Pre_GPS_LC_all_2018-09-18.csv")

pre.kd <- HR.analysis.step1(min_n, pre.all, tagproj, grid = 300)
post.kd <- HR.analysis.step1(min_n, post.all, tagproj, grid = 300)

h.pre.1 <- find.h.adhoc(pre.kd$list.data$all.utm)
## Section 3.1.2
##Visually optimized hlim = c(0.565,1.5), grid=300
# grid values from 50 to 300 don't change the outcome;
# extent values from 1 to 200 don't change the outcome either

h.pre <- round(h.pre.1$h)

pre.HR <- compute.area(h.pre, 
                       pre.kd$list.data, 
                       grid = 300)

h.post.1 <- find.h.adhoc(post.kd$list.data$all.utm)

h.post <- round(h.post.1$h)

post.HR <- compute.area(h.post, 
                       post.kd$list.data, 
                       grid = 300)

```

Select all possible combinations of 5 (nrow(ID.pre.min_n) - 1) to 16 (nrow(ID.post.min_n) - 1) individuals from the post data. There are 8008 possible combinations when min_n = 50. It takes a bit of time, I select 1000 of them. All these were ran using postUD_effects_n.Rmd. Results are saved in .rds files. 

First, we look at the change in computed areas as a function of sample sizes. 

```{r echo=FALSE, results="hide"}
post.summary <- read.csv("data/post_sample_summary_2018-09-18.csv")
ID.post.min_n <- filter(post.summary,
                       n.relocations > (min_n - 1))

pre.summary <- read.csv("data/pre_sample_summary_2018-09-18.csv")
ID.pre.min_n <- filter(pre.summary,
                       n.relocations > (min_n - 1))

#h.multiplier <-  seq(from = 0.1, to = 0.95, by = 0.05) 
# This loop takes a long time... It was run once already so start from 
# where it was left off. .RData file needs to be loaded to figure out
# how far along the first attempt was. 
grid <- 1000
extent <- 1

# select randomized results 
file.names <- list.files(path = "Rdata/", pattern = "areas_combos_n")

# initialize empty lists for collecting info
area50.list <- area95.list <- vector(mode = "list", length = length(file.names))
p.d50.list <- p.d95.list <- vector(mode = "list", length = length(file.names))
Fn.50.0 <- Fn.95.0 <- vector(mode = "numeric", length = length(file.names))

for (k in 1:length(file.names)){
  # find the sample size for this file:
  n.txt <- unlist(strsplit(strsplit(strsplit(file.names[k], 
                                             split = "areas_combos_")[[1]][2],
                                    split = "_2018-")[[1]][1], 
                           split = "n"))[2]
  
  areas.combos <- readRDS(file = paste0("Rdata/", file.names[k]))
  
  area50.list[[as.numeric(n.txt) - 4]] <- data.frame(area50 = areas.combos$area50,
                                                     n = as.numeric(n.txt))
  area95.list[[as.numeric(n.txt) - 4]] <- data.frame(area95 = areas.combos$area95,
                                                     n = as.numeric(n.txt))
  
  dif.50.df <- data.frame(dif = areas.combos$area50 - pre.HR$area.50)
  dif.95.df <- data.frame(dif = areas.combos$area95 - pre.HR$area.95)
  
  p.d50.list[[as.numeric(n.txt) - 4]] <- ggplot(data = dif.50.df) + 
    geom_histogram(aes(x = dif), binwidth = 0.1) +
    labs(title = paste0("n = ", n.txt), 
         x = "Difference in area (50%)", y = "Count")
  
  # find the ecdf of the differences
  Fn.50 <- ecdf(dif.50.df$dif)
  
  # compute the probability at 0:
  Fn.50.0[as.numeric(n.txt) - 4] <- Fn.50(0)
  
  #plot(hist.dif.50)
  
  p.d95.list[[as.numeric(n.txt) - 4]] <- ggplot(data = dif.95.df) + 
    geom_histogram(aes(x = dif), binwidth = 0.15) +
    labs(title = paste0("n = ", n.txt), 
         x = "Difference in area (95%)", y = "Count")
  
  # find the ecdf of the differences
  Fn.95 <- ecdf(dif.95.df$dif)
  
  # compute the probability at 0:
  Fn.95.0[as.numeric(n.txt) - 4] <- Fn.95(0)
  
}


```


Make plots to see how the areas changed with sample sizes

```{r}
area50.df <- do.call(rbind, area50.list)
area95.df <- do.call(rbind, area95.list)

pre.df <- data.frame(n = c(6, 6), 
                     areas = c(pre.HR$area.50, pre.HR$area.95))

post.df <- data.frame(n = c(17, 17), 
                     areas = c(post.HR$area.50, post.HR$area.95))
 
ggplot() + 
  geom_point(data = area50.df,
             aes(x = n, y = area50)) + 
  geom_point(data = area50.df,
             aes(x = n, y = mean(area50)),
             size = 4.5) + 
  geom_point(data = area95.df,
             aes(x = n, y = area95)) + 
  geom_point(data = area95.df,
             aes(x = n, y = mean(area95)),
             size = 4.5) + 
  geom_point(data = pre.df,
             aes(x = n, y = areas),
             color = "green",
             size = 3.5) + 
  geom_hline(yintercept = post.HR$area.50,
             size = 1.5, color = "blue",
             linetype = 2) + 
  geom_hline(yintercept = post.HR$area.95,
             size = 1.5, color = "blue",
             linetype = 2) + 
  
  labs(x = "Number of individuals",
       y = "Estimated UDs")
  

```



