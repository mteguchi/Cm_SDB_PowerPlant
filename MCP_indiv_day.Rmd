---
title: "MCP per day"
output: html_notebook
---

Computes a minimum convex polygon for each individual per day - is there a pattern in seaons or possibly temperature?


```{r}
rm(list = ls())
#getwd()
#list.files()

ifelse(Sys.info()[1] == 'Linux',
       source('~/Documents/R/tools/TomosFunctions.R'),
       source('~/R/tools/TomosFunctions.R'))

#Section 1: Load libraries and set wd
#library(readxl)
library(dplyr)
library(adehabitatHR)
library(rgdal)
library(leaflet) 
library(ggplot2)
library(lubridate)
library(tidyverse)
library(readr)

source("HR_analysis_fcns.R")

tagprj <- readOGR(dsn = "Tag_065_UTMzone11n", 
                  layer = "tag_065_project")
tagproj <- proj4string(tagprj)

min_n <- 50
n_days <- 7   # # days pooled to create a MCP
save.fig <- TRUE
save.files <- TRUE
```

Read in post and pre datasets

```{r, include=FALSE}
col.defs <- cols(ID = col_integer(),
                 ArgosID = col_integer(),
                 Message_Type = col_character(),
                 TransmissionDateTime = col_datetime(format = "%Y-%m-%d %H:%M:%S"),
                 LC = col_integer(),
                 Residual = col_double(),
                 Lat1 = col_double(),
                 Lon1 = col_double(),
                 inside = col_integer(),
                 UTCDateTime = col_datetime(format = "%Y-%m-%d %H:%M:%S"),
                 LocalDateTime = col_datetime(format = "%Y-%m-%d %H:%M:%S"),
                 Date2 = col_datetime(format = "%Y-%m-%d"),
                 LocalSunrise = col_datetime(format = "%Y-%m-%d %H:%M:%S"),
                 LocalSunset = col_datetime(format = "%Y-%m-%d %H:%M:%S"),
                 day1night2 = col_integer(),
                 row = col_integer(),
                 include = col_integer(),
                 hr = col_integer(),
                 ID.f = col_integer(),
                 DaysSinceFirst = col_double())

post.all <- read_csv("data/Post_GPS_LC_all_2018-09-18.csv",
                     col_types = col.defs)

post.all %>% count(by = ArgosID) %>%
    dplyr::filter(n > (min_n - 1)) %>%
    #dplyr::select(by) %>%
    rename(ArgosID = by) -> post.ID.min_n_day

post.list <- make.HR.dataset(post.all, post.ID.min_n_day, tagproj)

post.ID <- post.list$unique.ID

mcp.all <- mcp.area.all <- dates.all <- vector(mode = "list", 
                                               length = length(post.ID))
post.area.df <- data.frame(date = as.POSIXct(character()), 
                           area = numeric(), ID = numeric(),
                           lat.center = numeric(),
                           lon.center = numeric(),
                           days = numeric())
i <- r <- 1
for (i in 1:length(post.ID)){
  post.turtle1 <- post.list$eachID.utm[[i]]  
  post.turtle1.time <- post.list$eachID.time[[i]]
  post.turtle1.time$dif.time <- difftime(post.turtle1.time$UTC,
                                         post.turtle1.time$UTC[1], 
                                         units = "days")
  post.turtle1.latlon <- post.list$eachID.coords[[i]]

  n.steps <- as.numeric(floor(floor(max(post.turtle1.time$dif.time))/n_days))
  mcp1.area <- mcp1 <- dates <- center <- vector(mode = "list", 
                                                 length = n.steps)
  min.day <- 0
  n <- 1
  for (n in 1:n.steps){
    post.turtle1.ndays <- post.turtle1[post.turtle1.time$dif.time >= min.day &
                                         post.turtle1.time$dif.time < (min.day + n_days),]
    post.turtle1.time.ndays <- post.turtle1.time[post.turtle1.time$dif.time >= min.day &
                                                   post.turtle1.time$dif.time < (min.day + n_days),]
    post.turtle1.ndays.latlon <- post.turtle1.latlon[post.turtle1.time$dif.time >= min.day &
                                                   post.turtle1.time$dif.time < (min.day + n_days),]
    if (nrow(post.turtle1.ndays@coords) > 4){
      mcp1.area[[n]] <- mcp.area(post.turtle1.ndays, 
                                 percent = 100, 
                                 unin = "m", unout = "km2",
                                 plotit = FALSE)
      
      #mcp1[[n]] <- mcp(post.turtle1.ndays, 
      #                 percent = 100, 
      #                 unin = "m", unout = "km2")
      
      dates[[n]] <- post.turtle1.time.ndays[1, "UTC"]
      center[[n]] <- rgeos::gCentroid(post.turtle1.ndays.latlon)
      post.area.df[r, "area"] <- mcp1.area[[n]]
      post.area.df[r, "date"] <- dates[[n]]
      post.area.df[r, "lat.center"] <- center[[n]]$y
      post.area.df[r, "lon.center"] <- center[[n]]$x
      post.area.df[r, "days"] <- as.numeric( post.turtle1.time.ndays[ nrow( post.turtle1.time.ndays), 
                                                                     "dif.time"]) 
    }
    post.area.df[r, "ID"] <- post.ID[i]
    min.day <- min.day + n_days
    r <- r + 1
  }
  #mcp.all[[i]] <- mcp1
  mcp.area.all[[i]] <- mcp1.area
  dates.all[[i]] <- dates
  
  # for (k in 1:length(mcp.area.all[[i]])){
  #   if (length(mcp1.area[[k]]) > 0){
  #     post.area.df[r, "date"] <- dates[[k]] #as.Date(dates[[k]], format = "%Y-%m-%d %H:%M:%S") 
  #     post.area.df[r, "area"] <- mcp1.area[[k]]
  #     post.area.df[r, "ID"] <- post.ID[i]
  #     r <- r + 1
  #     
  #   }
  # }
    
}

# combine areas and dates into a dataframe
post.area.df %>% na.omit() %>%
  mutate(month = month(date),
         doy = yday(date)) -> post.area.df

p.7 <- ggplot() + 
  geom_point(data = post.area.df,
             aes(x = doy, y = area, color = as.factor(ID)),
             size = 2) + 
  geom_path(data = post.area.df,
             aes(x = doy, y = area, color = as.factor(ID)))

print(p.7)
#pre.all <- read.csv("data/Pre_GPS_LC_all_2018-09-18.csv")
#pre.ID <- unique(pre.all$ArgosID)
if (save.fig)
  ggsave(plot = p.7,
         filename = paste0("figures/doyVsArea_", n_days, "days_post.png"),
         device = "png",
         dpi = 600)
```

Do the same with the pre period
```{r, include=FALSE}
pre.all <- read_csv("data/Pre_GPS_LC_all_2018-09-18.csv",
                     col_types = col.defs)

pre.all %>% count(by = ArgosID) %>%
    filter(n > (min_n - 1)) %>%
    #dplyr::select(by) %>%
    rename(ArgosID = by) -> pre.ID.min_n_day

pre.list <- make.HR.dataset(pre.all, pre.ID.min_n_day, tagproj)

pre.ID <- pre.list$unique.ID

mcp.all <- mcp.area.all <- dates.all <- vector(mode = "list", length = length(post.ID))
pre.area.df <- data.frame(date = as.POSIXct(character()), 
                          area = numeric(), 
                          ID = numeric(),
                          lat.center = numeric(),
                          lon.center = numeric(),
                          days = numeric())
r <- 1
for (i in 1:length(pre.ID)){
  pre.turtle1 <- pre.list$eachID.utm[[i]]  
  pre.turtle1.time <- pre.list$eachID.time[[i]]
  pre.turtle1.time$dif.time <- difftime(pre.turtle1.time$UTC,
                                         pre.turtle1.time$UTC[1], 
                                         units = "days")
  pre.turtle1.latlon <- pre.list$eachID.coords[[i]]
  n.steps <- as.numeric(floor(floor(max(pre.turtle1.time$dif.time))/n_days))
  mcp1.area <- mcp1 <- dates <- center <- vector(mode = "list", length = n.steps)
  min.day <- 0
  for (n in 1:n.steps){
    pre.turtle1.ndays <- pre.turtle1[pre.turtle1.time$dif.time >= min.day &
                                         pre.turtle1.time$dif.time < (min.day + n_days),]
    pre.turtle1.time.ndays <- pre.turtle1.time[pre.turtle1.time$dif.time >= min.day &
                                                   pre.turtle1.time$dif.time < (min.day + n_days),]
  
    pre.turtle1.ndays.latlon <- pre.turtle1.latlon[pre.turtle1.time$dif.time >= min.day &
                                                   pre.turtle1.time$dif.time < (min.day + n_days),]
    
    if (nrow(pre.turtle1.ndays@coords) > 4){
      mcp1.area[[n]] <- mcp.area(pre.turtle1.ndays, 
                                 percent = 100, 
                                 unin = "m", unout = "km2",
                                 plotit = FALSE)
      
      #mcp1[[n]] <- mcp(post.turtle1.ndays, 
      #                 percent = 100, 
      #                 unin = "m", unout = "km2")
      
      dates[[n]] <- pre.turtle1.time.ndays[1, "UTC"]
      center[[n]] <- rgeos::gCentroid(pre.turtle1.ndays.latlon)
      pre.area.df[r, "area"] <- mcp1.area[[n]]
      pre.area.df[r, "date"] <- dates[[n]]
      pre.area.df[r, "lat.center"] <- center[[n]]$y
      pre.area.df[r, "lon.center"] <- center[[n]]$x
      pre.area.df[r, "days"] <- as.numeric( pre.turtle1.time.ndays[ nrow( pre.turtle1.time.ndays), 
                                                                     "dif.time"])
    }
    min.day <- min.day + n_days
    pre.area.df[r, "ID"] <- pre.ID[i]
    r <- r + 1
  }
  #mcp.all[[i]] <- mcp1
  mcp.area.all[[i]] <- mcp1.area
  dates.all[[i]] <- dates
  
  #for (k in 1:length(mcp.area.all[[i]])){
  #  if (length(mcp1.area[[k]]) > 0){
      #pre.area.df[r, "date"] <- dates[[k]] #as.Date(dates[[k]], format = "%Y-%m-%d %H:%M:%S") 
   #   pre.area.df[r, "area"] <- mcp1.area[[k]]
    #  pre.area.df[r, "ID"] <- pre.ID[i]
     # 
      
    #}
  #}
    
}

# combine areas and dates into a dataframe
pre.area.df %>% na.omit() %>%
  mutate(month = month(date),
         doy = yday(date)) -> pre.area.df

p.8 <- ggplot() + 
  geom_point(data = pre.area.df,
             aes(x = doy, y = area, color = as.factor(ID)),
             size = 2) +
  geom_line(data = pre.area.df,
             aes(x = doy, y = area, color = as.factor(ID)))
print(p.8)

if (save.fig)
  ggsave(plot = p.8,
         filename = paste0("figures/doyVsArea_", n_days, "days_pre.png"),
         device = "png",
         dpi = 600)

```


Is there any relationship with water temp?

```{r}
pre.area.df$PP <- 0
post.area.df$PP <- 1
area.df <- rbind(pre.area.df, post.area.df)
wtemp <- min_wtemp <- max_wtemp <- SD_wtemp <- vector(mode = "numeric", 
                                                      length = nrow(area.df))
k <- 1

for (k in 1:nrow(area.df)){
    begin.date <- date(area.df[k, "date"])
    end.date <- date(area.df[k, "date"] + days(n_days - 1))
    tmp.data <- getSDwtmp(begin.date, end.date,
                        outdir = "data/Wtmp_SDBay/")
    # nc format doesn't seem to work --- gets error using nc_open
    # 6 November 2018
    #datafileID <- nc_open(tmp.nc$filename)
    
    # these files have column headings in the first row and their
    # units in the second row. so, first two rows need to be removed
    col_names <- names(read_csv(tmp.data$filename$csv, n_max = 0))
    data.tmp <- read_csv(file = tmp.data$filename$csv,
                         col_names = col_names,
                         skip = 2) %>%
      filter(station == "SDBC1")
    
    wtemp[k] <- data.tmp %>%
      summarise(mean.wtmp = mean(as.numeric(wtmp), na.rm = TRUE))
    min_wtemp[k] <- data.tmp %>%
      summarise(min.wtmp = min(as.numeric(wtmp), na.rm = TRUE))
    max_wtemp[k] <- data.tmp %>%
      summarise(max.wtmp = max(as.numeric(wtmp), na.rm = TRUE))
    SD_wtemp[k] <- data.tmp %>%
      summarise(SD.wtmp = sd(as.numeric(wtmp), na.rm = TRUE))
}

area.df$wtemp <- unlist(wtemp)
area.df$min_wtemp <- unlist(min_wtemp)
area.df$max_wtemp <- unlist(max_wtemp)
area.df$SD_wtemp <- unlist(SD_wtemp)
area.df$dif_wtemp <- area.df$max_wtemp - area.df$min_wtemp

p.1 <- ggplot(data = area.df) +
  geom_point(aes(x = wtemp, y = area, 
                 color = as.factor(PP)),
             size = 3) #+ 
  #facet_grid(. ~ ID) + 
  #facet_wrap( ~ ID, nrow = 4)

if (save.fig)
  ggsave(plot = p.1,
         filename = paste0("figures/wtempVsArea_", n_days, "days.png"),
         device = "png",
         dpi = 600)

```

Any pattern with respect to day of year?
```{r}
area.df %>% mutate(doy = yday(date)) -> area.df
area.df %>% group_by(ID) %>% 
  summarise(lat.first = first(lat.center),
            PP = first(PP),
            date.first = first(date),
            area.first = first(area),
            days.first = first(days),
            wtemp.first = first(wtemp),
            min.wtemp.first = first(min_wtemp),
            max.wtemp.first = first(max_wtemp),
            SD.wtemp.first = first(SD_wtemp)) -> area.first.df

if (save.files)
  write.csv(area.df, 
            file = paste0("data/MCP_area_df_", n_days, "days.csv"),
            quote = FALSE,
            row.names = FALSE)

p.2 <- ggplot(data = area.df) + 
  geom_point(aes(x = doy, y = area, color = wtemp,
                 shape = as.factor(PP)),
             size = 3,
             alpha = 0.5)
print(p.2)

if (save.fig)
  ggsave(plot = p.2,
         filename = paste0("figures/doyVsAreaVsWtemp_", n_days, "days.png"),
         device = "png",
         dpi = 600)

```

Latitude?

```{r}
p.3 <- ggplot(data = filter(area.df, PP == 0)) + 
  geom_point(aes(x = wtemp, 
                 y = lat.center, 
                 color = as.factor(ID)),
             size = 2) + 
  geom_path(aes(x = wtemp, 
                 y = lat.center, 
                 color = as.factor(ID))) + 
  geom_point(data = filter(area.first.df, PP == 0),
             aes(x = wtemp.first,
                 y = lat.first,
                 color = as.factor(ID)),
             size = 4)
print(p.3)

if (save.fig)
  ggsave(plot = p.3,
         filename = paste0("figures/wtempVsLatCenter_", n_days, "days_pre.png"),
         device = "png",
         dpi = 600)

```

There is an increasing relationship between water temperature and the centers of MCPs for the pre period. 

```{r}
p.4 <- ggplot(data = filter(area.df, PP == 1)) + 
  geom_point(aes(x = wtemp, 
                 y = lat.center, 
                 color = as.factor(ID)))+
  geom_path(aes(x = wtemp, 
                 y = lat.center, 
                 color = as.factor(ID))) + 
  geom_point(data = filter(area.first.df, PP == 1),
             aes(x = wtemp.first,
                 y = lat.first,
                 color = as.factor(ID)),
             size = 4)

print(p.4)

if (save.fig)
  ggsave(plot = p.4,
         filename = paste0("figures/wtempVsLatCenter_", 
                           n_days, "days_post.png"),
         device = "png",
         dpi = 600)
```

For the post period, there also is an increasing relationship but a few turtles in the lower end makes it difficult to generalize. 

Did the center of MCPs changed with sampling time? 
```{r}
p.5 <- ggplot(data = dplyr::filter(area.df, PP == 0)) +
  geom_point(aes(x = days, 
                 y = lat.center, 
                 color = as.factor(ID)),
             size = 2) + 
  geom_path(aes(x = days, 
                y = lat.center, 
                color = as.factor(ID)))

print(p.5)
if (save.fig)
  ggsave(plot = p.5,
         filename = paste0("figures/daysVsLatCenter_", n_days, "days_pre.png"),
         device = "png",
         dpi = 600)
```


```{r}
p.6 <- ggplot(data = dplyr::filter(area.df, PP == 1)) +
  geom_point(aes(x = days, 
                 y = lat.center, 
                 color = as.factor(ID)),
             size = 2) + 
  geom_path(aes(x = days, 
                y = lat.center, 
                color = as.factor(ID)))
print(p.6)
if (save.fig)
  ggsave(plot = p.6,
         filename = paste0("figures/daysVsLatCenter_", n_days, "days_post.png"),
         device = "png",
         dpi = 600)
```

Try days vs area:
```{r}
p.9 <- ggplot(data = dplyr::filter(area.df, PP == 0)) +
  geom_point(aes(x = days, 
                 y = area, 
                 color = as.factor(ID)),
             size = 2) + 
    geom_line(aes(x = days, 
                 y = area, 
                 color = as.factor(ID)))
print(p.9)
if (save.fig)
  ggsave(plot = p.9,
         filename = paste0("figures/daysVsArea", n_days, "days_pre.png"),
         device = "png",
         dpi = 600)
```

And for the post period:
```{r}
p.10 <- ggplot(data = dplyr::filter(area.df, PP == 1)) +
  geom_point(aes(x = days, 
                 y = area, 
                 color = as.factor(ID)),
             size = 2) + 
    geom_line(aes(x = days, 
                 y = area, 
                 color = as.factor(ID)))
print(p.10)
if (save.fig)
  ggsave(plot = p.10,
         filename = paste0("figures/daysVsArea", n_days, "days_post.png"),
         device = "png",
         dpi = 600)
```



Visual analysis doesn't bring out any particular patterns... so let's try mixed-effects model with ID as a random effect.
```{r}
library(lme4)
fit.1 <- lmer(lat.center ~ PP + wtemp + SD_wtemp + (1 | ID), 
              data = area.df)
fit.2 <- lmer(lat.center ~ wtemp + SD_wtemp + (1 | ID), 
              data = area.df) 
fit.3 <- lmer(lat.center ~ PP +  SD_wtemp + (1 | ID), 
              data = area.df)
fit.4 <- lmer(lat.center ~ PP + wtemp + (1 | ID), 
              data = area.df) 
fit.5 <- lmer(lat.center ~ wtemp + (1 | ID), 
              data = area.df)
fit.6 <- lmer(lat.center ~ SD_wtemp + (1 | ID), 
              data = area.df)

anova(fit.1, fit.2, fit.3, fit.4, fit.5, fit.6)
summary(fit.5)
#plot(fit.1)
```

