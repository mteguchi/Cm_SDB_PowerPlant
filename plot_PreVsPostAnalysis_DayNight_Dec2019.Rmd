---
title: "Compare pre vs. post periods"
output: html_notebook
---

This file contains code to compare pre and post periods by randomly extracting the same number of individuals as the pre period from the post period without replacement and compare the calculated HR areas. It also looks at the northern most latitude of 95% and 50% UDs. Updated for the ms revision in December 2019.

```{r message=FALSE}
rm(list = ls())

# ifelse(Sys.info()[1] == 'Linux',
#        source('~/Documents/R/tools/TomosFunctions.R'),
#        source('~/R/tools/TomosFunctions.R'))‚å°

#library(readxl)
library(dplyr)
library(adehabitatHR)
library(rgdal)
library(leaflet) 
library(ggplot2)
library(lubridate)
library(tidyverse)
library(ggridges)

source("HR_analysis_fcns.R")

SDBay.gis <- spTransform(readOGR(dsn = "GISfiles",
                                 layer = "sd_bay",
                                 verbose = FALSE),
                         CRS("+proj=longlat +datum=WGS84"))

SDBay.df <- broom::tidy(SDBay.gis)
water.color <- "lightblue"
background.color <- "darkgray"
eelgrass.color <- "mediumseagreen"
post.50.color <- "blue4"
post.95.color <- "lightcyan"
pre.50.color <- "gold"
pre.95.color <- "lightgoldenrod1"

SDBay.eelg.2014 <- spTransform(readOGR(dsn = "GISfiles/Features",
                                       layer = "SD_Baywide_Eelgrass_2014_Final",
                                       verbose = F),
                               CRS("+proj=longlat +datum=WGS84"))
SDBay.eelg.2014.df <- broom::tidy(SDBay.eelg.2014)

SDBay.eelg.2008 <- spTransform(readOGR(dsn = "GISfiles/Features",
                                       layer = "SD_Baywide_Eelgrass_2008",
                                       verbose = F),
                               CRS("+proj=longlat +datum=WGS84"))

SDBay.eelg.2008.df <- broom::tidy(SDBay.eelg.2008)


# internet <- F #TRUE
save.fig <- F

# Minimum number of relocations per individual to be included in HR analysis
min_n <- 50
#N.end <- 32.69   # approx Coronado bridge
N.end <- 32.66 # changed from 32.69 because 152314 had a gap in data points between ~32.65 and ~32.66 - seems like there was a different behavior south and north of 32.66

grid <- 1000
extent <- 1

tagprj <- readOGR(dsn = "Tag_065_UTMzone11n", 
                  layer = "tag_065_project")
tagproj <- proj4string(tagprj)

# this file was created in PreVsPostAnalysis_DayNight_Dec2019.Rmd
all.data <- readRDS(file = "RData/PreVsPost_DayNight_Dec2019.RDS")

area.pre.daynight.95 <- get.area(spTransform(getverticeshr(all.data$UD.allID.pre.daynight, 95),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.day.95 <- get.area(spTransform(getverticeshr(all.data$UD.allID.pre.day, 95),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.night.95 <- get.area(spTransform(getverticeshr(all.data$UD.allID.pre.night, 95),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))

area.pre.daynight.50 <- get.area(spTransform(getverticeshr(all.data$UD.allID.pre.daynight, 50),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.day.50 <- get.area(spTransform(getverticeshr(all.data$UD.allID.pre.day, 50),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.night.50 <- get.area(spTransform(getverticeshr(all.data$UD.allID.pre.night, 50),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))

area.pre.daynight.95.byID <- get.area(lapply(all.data$UD.eachID.pre.daynight$UD.95,
                                             FUN = spTransform,
                                             CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.day.95.byID <- get.area(lapply(all.data$UD.eachID.pre.day$UD.95,
                                        FUN = spTransform,
                                        CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.night.95.byID <- get.area(lapply(all.data$UD.eachID.pre.night$UD.95,
                                          FUN = spTransform,
                                          CRS=CRS("+proj=longlat +datum=WGS84")))

area.pre.daynight.50.byID <- get.area(lapply(all.data$UD.eachID.pre.daynight$UD.50,
                                             FUN = spTransform,
                                             CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.day.50.byID <- get.area(lapply(all.data$UD.eachID.pre.day$UD.50,
                                        FUN = spTransform,
                                        CRS=CRS("+proj=longlat +datum=WGS84")))
area.pre.night.50.byID <- get.area(lapply(all.data$UD.eachID.pre.night$UD.50,
                                          FUN = spTransform,
                                          CRS=CRS("+proj=longlat +datum=WGS84")))

area.post.daynight.95 <- get.area(spTransform(getverticeshr(all.data$UD.allID.post.daynight, 95),
                                   CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.day.95 <- get.area(spTransform(getverticeshr(all.data$UD.allID.post.day, 95),
                                         CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.night.95 <- get.area(spTransform(getverticeshr(all.data$UD.allID.post.night, 95),
                                           CRS=CRS("+proj=longlat +datum=WGS84")))

area.post.daynight.50 <- get.area(spTransform(getverticeshr(all.data$UD.allID.post.daynight, 50),
                                              CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.day.50 <- get.area(spTransform(getverticeshr(all.data$UD.allID.post.day, 50),
                                         CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.night.50 <- get.area(spTransform(getverticeshr(all.data$UD.allID.post.night, 50),
                                           CRS=CRS("+proj=longlat +datum=WGS84")))

area.post.daynight.95.byID <- get.area(lapply(all.data$UD.eachID.post.daynight$UD.95,
                                              FUN = spTransform,
                                              CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.day.95.byID <- get.area(lapply(all.data$UD.eachID.post.day$UD.95,
                                         FUN = spTransform,
                                         CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.night.95.byID <- get.area(lapply(all.data$UD.eachID.post.night$UD.95,
                                           FUN = spTransform,
                                           CRS=CRS("+proj=longlat +datum=WGS84")))

area.post.daynight.50.byID <- get.area(lapply(all.data$UD.eachID.post.daynight$UD.50,
                                              FUN = spTransform,
                                              CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.day.50.byID <- get.area(lapply(all.data$UD.eachID.post.day$UD.50,
                                         FUN = spTransform,
                                         CRS=CRS("+proj=longlat +datum=WGS84")))
area.post.night.50.byID <- get.area(lapply(all.data$UD.eachID.post.night$UD.50,
                                           FUN = spTransform,
                                           CRS=CRS("+proj=longlat +datum=WGS84")))

```

Plot UDs by ID for pre period. Need to convert a spatial polygon list into a data frame. 

```{r, message=FALSE}
pre.IDs <- all.data$UD.eachID.pre.daynight$area$ID
pre.50.byID <- mapply(x = area.pre.daynight.50.byID, y = pre.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

pre.95.byID <- mapply(x = area.pre.daynight.95.byID, y = pre.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

pre.50.byID.df <- do.call(rbind, pre.50.byID)

pre.95.byID.df <- do.call(rbind, pre.95.byID)

p.KDE.pre.combined <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = pre.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = pre.95.color,
               alpha = 0.4) +

  geom_polygon(data = pre.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = pre.50.color,
               alpha = 0.6) +
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = eelgrass.color,
               alpha = 0.5) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = "black"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.border = element_rect(color = "black",
                                    fill = NA)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10))
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.665))
plot(p.KDE.pre.combined)

if (save.fig)
  ggsave(plot = p.KDE.pre.combined,
         filename = "figures/KDE_pre_combined_Dec2019.png",
         device = "png",
         dpi = 600)
```


Next, post period data are loaded and UDs for day and night combined are computed.
```{r, message=FALSE}
post.IDs <- all.data$UD.eachID.post.daynight$area$ID
post.50.byID <- mapply(x = area.post.daynight.50.byID, 
                       y = post.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

post.95.byID <- mapply(x = area.post.daynight.95.byID, 
                       y = post.IDs,
                       FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                       SIMPLIFY = F)

post.50.byID.df <- do.call(rbind, post.50.byID)

post.95.byID.df <- do.call(rbind, post.95.byID)

p.KDE.post.combined <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = post.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "mediumpurple1",
               alpha = 0.4) +

  geom_polygon(data = post.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "mediumpurple4",
               alpha = 0.4) +
  geom_polygon(data = SDBay.eelg.2014.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 3) + 
  labs(x = "", y = "")+ 
  theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
   scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) +
   scale_y_continuous(breaks = c(32.60, 32.62, 32.64, 32.66))
plot(p.KDE.post.combined)

if (save.fig)
  ggsave(plot = p.KDE.post.combined,
         filename = "figures/KDE_post_combined_Dec2019.png",
         device = "png",
         dpi = 600)
```


We then pull out just day time for the pre period. One turtle cannot be analyzed because there were not enough relocation points in the day time. 
```{r}
pre.day.IDs <- all.data$UD.eachID.pre.day$area$ID
pre.day.50.byID <- mapply(x = area.pre.day.50.byID, 
                       y = pre.day.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

pre.day.95.byID <- mapply(x = area.pre.day.95.byID, 
                       y = pre.day.IDs,
                       FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                       SIMPLIFY = F)

pre.day.50.byID.df <- do.call(rbind, pre.day.50.byID)

pre.day.95.byID.df <- do.call(rbind, pre.day.95.byID)

p.KDE.pre.day <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "mediumseagreen",
               alpha = 0.5) +
  geom_polygon(data = pre.day.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightcyan",
               alpha = 0.6) +

  geom_polygon(data = pre.day.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "blue4",
               alpha = 0.6) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
  theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.665))
plot(p.KDE.pre.day)

if (save.fig)
  ggsave(plot = p.KDE.pre.day,
         filename = "figures/KDE_pre_day_Dec2019.png",
         device = "png",
         dpi = 600)

```

Pre-day KDEs for 44366 has two "dots"... what's going on there? 12/4/2018 - has been fixed. It was caused by "rounding" the estimated h value for this animal. Changed it to "ceiling" which eliminated the tiny "dots". 12/4/2018.

Do the same for the nighttime for the pre period and plot on top of the daytime UDs.

```{r}
pre.night.IDs <- all.data$UD.eachID.pre.night$area$ID
pre.night.50.byID <- mapply(x = area.pre.night.50.byID, 
                       y = pre.night.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

pre.night.95.byID <- mapply(x = area.pre.night.95.byID, 
                       y = pre.night.IDs,
                       FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                       SIMPLIFY = F)

pre.night.50.byID.df <- do.call(rbind, pre.night.50.byID)

pre.night.95.byID.df <- do.call(rbind, pre.night.95.byID)


p.KDE.pre.day.night <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "mediumseagreen",
               alpha = 0.5) +
  geom_polygon(data = pre.day.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightcyan",
               alpha = 0.6) +

  geom_polygon(data = pre.day.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "blue4",
               alpha = 0.6) +

  geom_polygon(data = pre.night.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightpink",
               alpha = 0.5) +

  geom_polygon(data = pre.night.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "red4",
               alpha = 0.5) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
  theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) + 
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.665))
plot(p.KDE.pre.day.night)

if (save.fig)
  ggsave(plot = p.KDE.pre.day.night,
         filename = "figures/KDE_pre_day_night_Dec2019.png",
         device = "png",
         dpi = 600)

```

Post period and daytime. 

```{r}
post.day.IDs <- all.data$UD.eachID.post.day$area$ID
post.day.50.byID <- mapply(x = area.post.day.50.byID, 
                       y = post.day.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

post.day.95.byID <- mapply(x = area.post.day.95.byID, 
                       y = post.day.IDs,
                       FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                       SIMPLIFY = F)

post.day.50.byID.df <- do.call(rbind, post.day.50.byID)

post.day.95.byID.df <- do.call(rbind, post.day.95.byID)

p.KDE.post.day <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = SDBay.eelg.2014.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = eelgrass.color,
               alpha = 0.5) +
  geom_polygon(data = post.day.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = post.95.color,
               alpha = 0.6) +

  geom_polygon(data = post.day.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = post.50.color,
               alpha = 0.6) +
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = "transparent", #water.color,
               color = "black") +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
  theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.post.day,
         filename = "figures/KDE_post_day_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.post.day)

```

Post period night time overlayed on top of daytime. 

```{r}
post.night.IDs <- all.data$UD.eachID.post.night$area$ID
post.night.50.byID <- mapply(x = area.post.night.50.byID, 
                       y = post.night.IDs,
                      FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                      SIMPLIFY = F)

post.night.95.byID <- mapply(x = area.post.night.95.byID, 
                       y = post.night.IDs,
                       FUN = function(x, y) broom::tidy(x) %>% mutate(ID = y),
                       SIMPLIFY = F)

post.night.50.byID.df <- do.call(rbind, post.night.50.byID)
post.night.95.byID.df <- do.call(rbind, post.night.95.byID)

p.KDE.post.day.night <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = post.day.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightcyan",
               alpha = 0.6) +
  # geom_polygon(data = KD.eachID.post.day$vert.75.df,
  #              aes(x = long, y = lat,
  #                  group = group),
  #              color = "black",
  #              fill = "deepskyblue",
  #              alpha = 0.7) +
  
  geom_polygon(data = post.day.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "blue4",
               alpha = 0.6) +
  geom_polygon(data = post.night.95.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightpink",
               alpha = 0.5) +
  # geom_polygon(data = KD.eachID.post.night$vert.75.df,
  #              aes(x = long, y = lat,
  #                  group = group),
  #              color = "black",
  #              fill = "indianred",
  #              alpha = 0.3) +
  
  geom_polygon(data = post.night.50.byID.df,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "red4",
               alpha = 0.5) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 3) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10))
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.post.day.night,
         filename = "figures/KDE_post_day_night_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.post.day.night)
```

Make plots for all turtles, including pre and post periods.

```{r}

day.vert.50 <- rbind(pre.day.50.byID.df,
                     post.day.50.byID.df)
day.vert.95 <- rbind(pre.day.95.byID.df,
                     post.day.95.byID.df)

night.vert.50 <- rbind(pre.night.50.byID.df,
                     post.night.50.byID.df)
night.vert.95 <- rbind(pre.night.95.byID.df,
                     post.night.95.byID.df)

# pre.day.vert.95 <- KD.eachID.pre.day$vert.95.df
# pre.night.vert.95 <- KD.eachID.pre.night$vert.95.df
# post.day.vert.95 <- KD.eachID.post.day$vert.95.df
# post.night.vert.95 <- KD.eachID.post.night$vert.95.df
# 
# day.vert.95 <- rbind(pre.day.vert.95, post.day.vert.95)
# night.vert.95 <- rbind(pre.night.vert.95, post.night.vert.95)
# 
# pre.day.vert.50 <- KD.eachID.pre.day$vert.50.df
# pre.night.vert.50 <- KD.eachID.pre.night$vert.50.df
# post.day.vert.50 <- KD.eachID.post.day$vert.50.df
# post.night.vert.50 <- KD.eachID.post.night$vert.50.df
# 
# day.vert.50 <- rbind(pre.day.vert.50, post.day.vert.50)
# night.vert.50 <- rbind(pre.night.vert.50, post.night.vert.50)

p.KDE.pre.post.day.night <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = day.vert.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightcyan",
               alpha = 0.6) +
  # geom_polygon(data = KD.eachID.post.day$vert.75.df,
  #              aes(x = long, y = lat,
  #                  group = group),
  #              color = "black",
  #              fill = "deepskyblue",
  #              alpha = 0.7) +
  
  geom_polygon(data = day.vert.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "blue4",
               alpha = 0.6) +
  geom_polygon(data = night.vert.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightpink",
               alpha = 0.5) +
  # geom_polygon(data = KD.eachID.post.night$vert.75.df,
  #              aes(x = long, y = lat,
  #                  group = group),
  #              color = "black",
  #              fill = "indianred",
  #              alpha = 0.3) +
  
  geom_polygon(data = night.vert.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "red4",
               alpha = 0.5) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 4) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.665))  
  # # scale_x_continuous(breaks = c(-117.14, -117.12, -117.10),
  #                    limits = c(-117.14, -117.085)) +
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
  #                    limits = c(32.595, 32.655))

if (save.fig)
  ggsave(plot = p.KDE.pre.post.day.night,
         filename = "figures/KDE_pre_post_day_night_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.pre.post.day.night)

```



Combine all turtles together - day and night. 


```{r}
pre.daynight.95 <- broom::tidy(area.pre.daynight.95) %>% 
  mutate(daynight = "day+night", period = "pre")
pre.daynight.50 <- broom::tidy(area.pre.daynight.50) %>% 
  mutate(daynight = "day+night", period = "pre")


p.KDE.pre.all <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = pre.daynight.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightgoldenrod1",
               alpha = 0.6) +
  geom_polygon(data = pre.daynight.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "gold",
               alpha = 0.6) +
  
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  # facet_grid(. ~ ID) +
  # facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64, 32.66),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.pre.all,
         filename = "figures/KDE_pre_all_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.pre.all)
```


```{r}
post.daynight.95 <- broom::tidy(area.post.daynight.95) %>% 
  mutate(daynight = "day+night", period = "post")
post.daynight.50 <- broom::tidy(area.post.daynight.50) %>% 
  mutate(daynight = "day+night", period = "post")

p.KDE.pre.post.all <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = pre.daynight.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightgoldenrod1",
               alpha = 0.6) +
  geom_polygon(data = pre.daynight.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "gold",
               alpha = 0.6) +
     geom_polygon(data = post.daynight.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightgreen",
               alpha = 0.5) +
  geom_polygon(data = post.daynight.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "green1",
               alpha = 0.5) +
  
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  # facet_grid(. ~ ID) +
  # facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10))
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64, 32,66),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.pre.post.all,
         filename = "figures/KDE_pre_post_all_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.pre.post.all)
```

Then split these into day and night.


Plot pre night vs day
```{r}
pre.day.95 <- broom::tidy(area.pre.day.95) %>% mutate(daynight = "day", period = "pre")
pre.day.50 <- broom::tidy(area.pre.day.50) %>% mutate(daynight = "day", period = "pre")

pre.night.95 <- broom::tidy(area.pre.night.95) %>% mutate(daynight = "night", period = "pre")
pre.night.50 <- broom::tidy(area.pre.night.50)%>% mutate(daynight = "night", period = "pre")

pre.95 <- rbind(pre.day.95, pre.night.95)
pre.50 <- rbind(pre.day.50, pre.night.50)

p.KDE.pre.DayVsNight <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = pre.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightgoldenrod1",
               alpha = 0.6) +
  geom_polygon(data = pre.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "gold",
               alpha = 0.6) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ daynight) +
  # facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64, 32.66),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.pre.DayVsNight,
         filename = "figures/KDE_pre_DayVsNight_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.pre.DayVsNight)
```


Plot post night vs day
```{r}

post.day.95 <- broom::tidy(area.post.day.95) %>% mutate(daynight = "day", period = "post")
post.day.50 <- broom::tidy(area.post.day.50) %>% mutate(daynight = "day", period = "post")


post.night.95 <- broom::tidy(area.post.night.95) %>% mutate(daynight = "night", period = "post")
post.night.50 <- broom::tidy(area.post.night.50)%>% mutate(daynight = "night", period = "post")

post.95 <- rbind(post.day.95, post.night.95)
post.50 <- rbind(post.day.50, post.night.50)

p.KDE.post.DayVsNight <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +
  geom_polygon(data = post.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightgreen",
               alpha = 0.6) +
  geom_polygon(data = post.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "green1",
               alpha = 0.6) +
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(. ~ daynight) +
  # facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64, 32.66),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.post.DayVsNight,
         filename = "figures/KDE_post_DayVsNight_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.post.DayVsNight)
```

pre vs post vs day vs night

```{r}
all.50 <- rbind(pre.daynight.50, pre.50, post.daynight.50, post.50)
all.95 <- rbind(pre.daynight.95, pre.95, post.daynight.95, post.95)


# UD.pre.50.latlon$daynight <- "day+night"
# UD.pre.50.latlon$period <- "pre"
# 
# UD.pre.95.latlon$daynight <- "day+night"
# UD.pre.95.latlon$period <- "pre"
# 
# UD.post.50.latlon$daynight <- "day+night"
# UD.post.50.latlon$period <- "post"
# 
# UD.post.95.latlon$daynight <- "day+night"
# UD.post.95.latlon$period <- "post"
# 
# UD.pre.day.night.50.latlon$period <- "pre"
# UD.pre.day.night.95.latlon$period <- "pre"
# 
# UD.post.day.night.50.latlon$period <- "post"
# UD.post.day.night.95.latlon$period <- "post"
# 
# UD.pre.post.day.night.50 <- rbind(UD.pre.day.night.50.latlon,
#                                   UD.post.day.night.50.latlon,
#                                   UD.pre.50.latlon,
#                                   UD.post.50.latlon)
# 
# UD.pre.post.day.night.95 <- rbind(UD.pre.day.night.95.latlon,
#                                   UD.post.day.night.95.latlon,
#                                   UD.pre.95.latlon,
#                                   UD.post.95.latlon)

all.50$daynight.f <- factor(all.50$daynight,
                            levels = c("day", "night", "day+night"))

all.95$daynight.f <- factor(all.95$daynight,
                            levels = c("day", "night", "day+night"))

all.50$period.f <- factor(all.50$period,
                          levels = c("pre", "post"))

all.95$period.f <- factor(all.95$period,
                          levels = c("pre", "post"))

p.KDE.pre.post.DayVsNight <- ggplot() + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat, group = group),
               fill = water.color,
               color = "black") +

  geom_polygon(data = all.95,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "lightgreen",
               alpha = 0.6) +
  geom_polygon(data = all.50,
               aes(x = long, y = lat,
                   group = group),
               color = "black",
               fill = "green1",
               alpha = 0.6) +
  
  coord_map(xlim = c(-117.145, -117.09),
            ylim = c(32.595, 32.665)) + 
  facet_grid(daynight.f ~ period.f) +
  # facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = background.color,
                                        colour = background.color),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.13, -117.11, -117.09)) 
  # scale_y_continuous(breaks = c(32.60, 32.62, 32.64, 32.66),
  #                    limits = c(32.595, 32.665))

if (save.fig)
  ggsave(plot = p.KDE.pre.post.DayVsNight,
         filename = "figures/KDE_preVspost_DayVsNight_Dec2019.png",
         device = "png",
         dpi = 600)

plot(p.KDE.pre.post.DayVsNight)
```



