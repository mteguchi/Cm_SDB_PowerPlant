---
title: "Home range analysis for green turtles in San Diego Bay (2019-10-31)"
output: html_notebook
---

San Diego Bay Turtle Movement Analysis
Original R Code, JT Froeschke, December 29, 2015
Data modified from previous versions by SE Graham, June 2016, May 2018
Data modified from May 2018 by T EGuchi, July 2018

Filtered data utilize GPS, and Argos LC = 1,2,3
Filtered data do not include points on land
Filtered data only allow for 1 relocation every 4 horus

Purpose of the script is to compute homerange (area) using 
least squares cross-validation including 50% and 95% contours.
An analysis of each turtle and an aggregate pre and post will be computed
h values are chosen based on best judgment and gst behavior  

2019-10-31: For this revision, GPS and Argos locations are split, as per a reviewer's suggestion. In order to put all analysis in one, I redo all the steps. 

```{r}
rm(list = ls())

#Section 1: Load libraries and set wd
#library(readxl)
library(tidyverse)
library(adehabitatHR)
library(rgdal)
library(leaflet) 
library(ggplot2)
library(lubridate)
library(StreamMetabolism)

# The date the first few chunks were run to find inside/outside, day/night, and split into 4-hr blocks. 
run.date <- "2019-11-01"
save.figure <- F

# Minimum number of relocations per individual to be included in HR analysis
min_n <- 50
#N.end <- 32.69   # approx Coronado bridge
N.end <- 32.66 # changed from 32.69 because 152314 had a gap in data points between ~32.65 and ~32.66 - seems like there was a different behavior south and north of 32.66
grid.value <- 1000

# max residual value
res.limit <- 35.0

LCs<-c("1","2","3")

source("HR_analysis_fcns.R")

```


Section 2: read in data

First, read the raw data and find whether or not each location is inside or outside SDB. 
```{r}

dNames <- paste0("data/files_Oct2019_withNewTags/", c("pre", "post", "new"))
SDBay <- read.csv("data/SDBay_polygon.csv")

for (d in 1:length(dNames)){
  data.files <- dir(dNames[d], pattern = ".txt")
  
  for (k in 1:length(data.files)){
    if (!file.exists(paste0(dNames[d], "/", unlist(strsplit(data.files[k], '.txt'))[1],
                            "_inout.csv"))){
      dat <- read.csv(paste0(dNames[d], "/", data.files[k]))
      in.out <- vector(mode = "numeric", length = dim(dat)[1])
      for (k1 in 1:length(in.out)){
        in.out[k1] <- point.in.polygon(dat$Lon1[k1], dat$Lat1[k1],
                                       SDBay$long, SDBay$lat)
      }
      dat$inside <- in.out
      
      write.csv(dat,
                file = paste0(dNames[d], "/", unlist(strsplit(data.files[k], '.txt'))[1],
                              "_inout.csv"),
                quote = F, row.names = F)
      
      dat.inside <- filter(dat, inside == 1)
      write.csv(dat.inside,
                file = paste0(dNames[d], "/", unlist(strsplit(data.files[k], '.txt'))[1],
                              "_inside.csv"),
                quote = F, row.names = F)
      
    }

    #plot(SDBay$long, SDBay$lat, type = 'l')
    #points(dat$Lon1[in.out == 1], dat$Lat1[in.out == 1], col = 'green')
    #points(dat$Lon1[in.out == 0], dat$Lat1[in.out == 0], col = 'red')
  }
  
}


```


Then do some Argos filtering both for inside and inout.

```{r}

ID.names <- function(name){
  x <- unlist(strsplit(name, '_'))[1]
  return(x)
}

# get the beginning and end dates of each data file
get.dates.1 <- function(data.file){
  data.file$Date1 <- as.POSIXct(strptime(data.file$TransmissionDateTime,
                                         "%m-%d-%Y %H:%M:%S"),
                                tz = "GMT")
  
  #data.file$Date2 <- as.character(data.file$Date, format = "%Y/%m/%d")
  date.begin <- min(data.file$Date, na.rm = T)
  date.end <- max(data.file$Date, na.rm = T)
  out <- list(begin = date.begin, end = date.end)
  return(out)
}

get.dates.2 <- function(data.file){
  data.file$Date <- as.POSIXct(strptime(data.file$TransmissionDateTime,
                                        "%m/%d/%Y %H:%M:%S"),
                               tz = "GMT")
  #data.file$Date2 <- as.character(data.file$Date, format = "%Y/%m/%d")
  date.begin <- min(data.file$Date, na.rm = T)
  date.end <- max(data.file$Date, na.rm = T)
  out <- list(begin = date.begin, end = date.end)
  return(out)
}

fix.date.1 <- function(x){
  x$UTCDateTime <- as.POSIXct(strptime(x$TransmissionDateTime,
                                       "%m-%d-%Y %H:%M:%S"),
                              tz = "GMT")
  return(x)
} 

fix.date.2 <- function(x){
  x$UTCDateTime <- as.POSIXct(strptime(x$TransmissionDateTime,
                                       "%m/%d/%Y %H:%M:%S"),
                              tz = "GMT")
  return(x)
}

dataset <- c("inside", "inout")
d <- k1 <- 1
for (d in 1:length(dNames)){
    
  for (k1 in 1:2){
    if (k1 == 1){
      all.files <- as.list(list.files(dNames[d], pattern = "_inside.csv"))
    } else {
      all.files <- as.list(list.files(dNames[d], pattern = "_inout.csv"))
    }

    IDs <- unlist(lapply(all.files, FUN = ID.names))
    if (!file.exists(paste0(dNames[d], "/", IDs[1], "_", dataset[k1], "_DayNight.csv"))){
      
      all.data <- lapply(all.files,
                         FUN = function(x) read.csv(paste0(dNames[d], "/", x)))
      
      if (d != 3){
        dates.begin.end <- lapply(all.data, FUN = get.dates.1)
        all.data <- lapply(all.data, FUN = fix.date.1)
        
      } else {
        dates.begin.end <- lapply(all.data, FUN = get.dates.2)
        all.data <- lapply(all.data, FUN = fix.date.2)
      }
      
      #filters each Argos tag for nums (LC 1,2,3) and GPS, which eliminates Argos A,B,Z,0
      ## | represents or
      
      filtered.data <- lapply(all.data,
                              FUN = function(x){
                                x %>% 
                                  filter(LC %in% LCs | Message_Type=="GPS") %>%
                                  dplyr::select(ID, ArgosID, Message_Type,
                                                TransmissionDateTime, UTCDateTime,
                                                LC, Residual,
                                                Lat1, Lon1, inside) %>%
                                  
                                  mutate(LocalDateTime = with_tz(UTCDateTime,
                                                                 tzone = "America/Los_Angeles")) %>%
                                  mutate(Date2 = as.character(LocalDateTime,
                                                              format = "%Y/%m/%d")) %>%
                                  filter(!is.na(Lat1))})
      
      # then find sunrise/sunset for each line of the data files:
      filtered.rise.set <- lapply(filtered.data,
                                  FUN = function(x){
                                    rise <- set <- vector(mode = "numeric",
                                                          length = dim(x)[1])
                                    
                                    for (k in 1:dim(x)[1]){
                                      tmp <- sunrise.set(lat = x$Lat1[k],
                                                         long = x$Lon1[k],
                                                         date = x$Date2[k],
                                                         timezone = "America/Los_Angeles")
                                      
                                      rise[k] <- tmp$sunrise
                                      set[k] <- tmp$sunset
                                    }
                                    
                                    x$LocalSunrise <- as.POSIXct(rise,
                                                                 origin = "1970-01-01 00:00.00 UTC")
                                    x$LocalSunset <- as.POSIXct(set,
                                                                origin = "1970-01-01 00:00.00 UTC")
                                    
                                    x$day1night2 <- ifelse((x$LocalDateTime > x$LocalSunrise &
                                                              x$LocalDateTime < x$LocalSunset),
                                                           1, 2)
                                    return(x)
                                  })
      
      for (k in 1:length(filtered.rise.set)){
        
          outfile <- paste0(dNames[d], "/", IDs[k], "_", dataset[k1], "_DayNight.csv")
          write.csv(filtered.rise.set[[k]],
                    file = outfile,
                    quote = F, 
                    row.names=F)
          
      }
    }
  }
  
}

```
  
Then, split them into 4-hour segments. This part will be split into GPS and Argos data files:

```{r}
d <- k0 <- k1 <- k2 <- 1
for (d in 1:length(dNames)){
  all.files <- dir(dNames[d], "_inside_DayNight")
  
  for (k0 in 1:length(all.files)){
    id <- unlist(strsplit(all.files[k0], '_'))[1]
    
    fileout.gps <- paste0(dNames[d], '/', id, "_inside_DayNight_4hrs_GPS.csv")

    fileout.argos <- paste0(dNames[d], '/', id, "_inside_DayNight_4hrs_ARGOS.csv")

    if (!file.exists(paste0(dNames[d], '/', id, "_inside_DayNight_4hrs_GPS.csv"))){
      dat <- read.csv(paste0(dNames[d], '/', all.files[k0]))
      
      # create hours column:
      dat$hr <- hour(dat$LocalDateTime)
      
      dat %>% filter(Message_Type == "GPS") -> dat.gps
      dat %>% filter(Message_Type != "GPS") -> dat.argos
      
      write(x = colnames(dat), file = fileout.gps,
            sep = ",", ncolumns = dim(dat.gps)[2])
      
      write(x = colnames(dat), file = fileout.argos,
            sep = ",", ncolumns = dim(dat.argos)[2])
      
      files <- c(fileout.gps, fileout.argos)
      dat.list <- list(dat.gps, dat.argos)
      
      for (k2 in 1:2){
        dat <- dat.list[[k2]]
        
        # we need to know which dates we have
        # use Y/m/d column
        uniq.dates <- levels(dat$Date2)
        for (k in 1:length(uniq.dates)){
          tmp1 <- dat[dat$Date2 == uniq.dates[k],]
          # then split into four-hr segments:
          # 0-4, 4-8, 8-12, 12-16, 16-20, 20-24
          for (k1 in 1:6){
            tmp2 <- tmp1[tmp1$hr >= ((k1-1) * 4) & tmp1$hr < (k1*4), ]
            if (dim(tmp2)[1] != 0){
              if (k2 == 1){
                res.num <- as.numeric(tmp2$Residual)
                ifelse(res.num <= res.limit,
                       tmp3 <- tmp2[res.num == min(res.num),],
                       tmp3 <- NA)
                
              } else {
                LC.num <- as.numeric(tmp2$LC)
                tmp3 <- tmp2[LC.num == max(LC.num),]
              }
              
              if (length(tmp3) > 1){
                write.table(tmp3[1,], file = files[[k2]], sep = ",",
                            append = T, quote = F, col.names = F,
                            row.names = F)
                
              }
            }
          }
          
        }
      }
      
    }
  }
}

```

Section 2.1: Pre

In this chunk, I summarize how many of data points were removed for each telemetry method (GPS and ARGOS). So, I need to use the original and filtered data. 

```{r}
pre.summary <- get.summary.1(dNames[1])

if (!file.exists(paste0("data/pre_sample_summary_", 
                        run.date, ".csv")))
  write.csv(pre.summary$raw.summary,
            paste0("data/pre_sample_summary_", 
                   run.date, ".csv"),
            row.names = F, 
            quote = F)

if (!file.exists(paste0("data/Pre_GPS_", 
                        run.date, ".csv")))
  write.csv(pre.summary$GPS.summary, 
            paste0("data/Pre_GPS_", 
                   run.date, ".csv"),
            row.names = F,
            quote = F)

if (!file.exists(paste0("data/Pre_ARGOS_", 
                        run.date, ".csv")))
  write.csv(pre.summary$ARGOS.summary, 
            paste0("data/Pre_ARGOS_", 
                   run.date, ".csv"),
            row.names = F,
            quote = F)

```

Plot the data points to see what they look like:

Get some base layer maps here:

```{r}
# just use the 2014 eelgrass data - there are old data files also
SDBay.eelg.2014 <- spTransform(readOGR(dsn = "GISfiles/Features",
                                       layer = "SD_Baywide_Eelgrass_2014_Final",
                                       verbose = F),
                               CRS("+proj=longlat +datum=WGS84"))
SDBay.eelg.2014.df <- broom::tidy(SDBay.eelg.2014)

SDBay.eelg.2008 <- spTransform(readOGR(dsn = "GISfiles/Features",
                                       layer = "SD_Baywide_Eelgrass_2008",
                                       verbose = F),
                               CRS("+proj=longlat +datum=WGS84"))
SDBay.eelg.2008.df <- broom::tidy(SDBay.eelg.2008)


sdbay.all <- readRDS(file = 'RData/sdbay_all.rds')
sdbay.south <- readRDS(file = 'RData/sdbay_south.rds')
sdbay.med <- readRDS(file = 'RData/sdbay_med.rds')

map.sdbay.zm <- ggmap::ggmap(sdbay.all)

map.sdbay.south <- ggmap::ggmap(sdbay.south)

map.sdbay.med <- ggmap::ggmap(sdbay.med)

# read in the SDB shape file:
SDB.shape <- readOGR(dsn = "GISfiles", layer = "sd_bay")
SDBay <- spTransform(readOGR(dsn = "GISfiles",
                             layer = "sd_bay",
                             verbose = F),
                     CRS("+proj=longlat +datum=WGS84"))
SDBay.df <- broom::tidy(SDBay)

water <- spTransform(readOGR(dsn = "GISfiles", 
                             layer = "water",
                             verbose = F),
                     CRS("+proj=longlat +datum=WGS84"))
water.df <- broom::tidy(water) %>%
  filter(lat < 32.75 & lat > 32.58 & long > -117.25)

tagprj <- readOGR(dsn = "Tag_065_UTMzone11n", 
                  layer = "tag_065_project")
tagproj <- proj4string(tagprj)

# not sure what this part is doing... 
latlong = "+init=epsg:4326"
```

```{r}
map.pre <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = pre.summary$raw,
             aes(x = Lon1, y = Lat1, color = ID.f),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  theme(legend.title = element_text(size = 10, hjust = 0.5),
        legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

if (save.figure)
  ggsave(filename = "figures/map_pre_raw.png",
         plot = map.pre,
         device = "png",
         dpi = 600)
plot(map.pre)

```

Using only GPS data that were included in the analysis:

```{r}
map.pre.GPS <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = pre.summary$GPS,
             aes(x = Lon1, y = Lat1, color = ID.f),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  theme(legend.title = element_text(size = 10, hjust = 0.5),
        legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

if (save.figure)
  ggsave(filename = "figures/map_pre_GPS.png",
         plot = map.pre.GPS,
         device = "png",
         dpi = 600)
plot(map.pre.GPS)
```

Using only ARGOS data that were included in the analysis:

```{r}
map.pre.ARGOS <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = pre.summary$ARGOS,
             aes(x = Lon1, y = Lat1, color = ID.f),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  theme(legend.title = element_text(size = 10, hjust = 0.5),
        legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

if (save.figure)
  ggsave(filename = "figures/map_pre_ARGOS.png",
         plot = map.pre.ARGOS,
         device = "png",
         dpi = 600)
plot(map.pre.ARGOS)
```

Do the same with the post datasets. And probably we should inlude the new files into "post". Also, take out the one track that goes out the bay - north of 32.66N

```{r}

post.summary <- get.summary.1(dNames[2])
new.summary <- get.summary.1(dNames[3], date.format = "%m/%d/%Y %H:%M:%S")

post.all <- rbind(post.summary$raw, new.summary$raw) %>%
  filter(Lat1 < 32.66)
post.GPS <- rbind(post.summary$GPS, new.summary$GPS) %>%
  filter(Lat1 < 32.66) 
post.ARGOS <- rbind(post.summary$ARGOS, new.summary$ARGOS) %>%
  filter(Lat1 < 32.66)

if (!file.exists(paste0("data/post_sample_summary_", 
                        run.date, ".csv")))
  write.csv(rbind(post.summary$raw.summary, new.summary$raw.summary),
            paste0("data/post_sample_summary_", 
                   run.date, ".csv"),
            row.names = F, 
            quote = F)

if (!file.exists(paste0("data/Post_GPS_", 
                        run.date, ".csv")))
  write.csv(rbind(post.summary$GPS.summary, new.summary$GPS.summary), 
            paste0("data/Post_GPS_", 
                   run.date, ".csv"),
            row.names = F,
            quote = F)

if (!file.exists(paste0("data/Post_ARGOS_", 
                        run.date, ".csv")))
  write.csv(rbind(post.summary$ARGOS.summary, new.summary$ARGOS.summary), 
            paste0("data/Post_ARGOS_", 
                   run.date, ".csv"),
            row.names = F,
            quote = F)
```


```{r}

map.post <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) + 
               #fill = "blue",
               #alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2014.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.6) +
  geom_point(data = post.all,
             aes(x = Lon1, y = Lat1, color = ID.f),
             alpha = 0.5)+ 
  labs(color = 'ARGOS ID') + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        #legend.position = c(0.2, 0.5),
    legend.position = "none")

if (save.figure)
  ggsave(filename = "figures/map_post_raw_2.png",
         plot = map.post,
         device = "png",
         dpi = 600)

plot(map.post)
```


```{r}
map.post.GPS <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = post.GPS,
             aes(x = Lon1, y = Lat1, color = ID.f),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  theme(legend.title = element_text(size = 10, hjust = 0.5),
        legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

if (save.figure)
  ggsave(filename = "figures/map_post_GPS.png",
         plot = map.post.GPS,
         device = "png",
         dpi = 600)
plot(map.post.GPS)
```

Using only ARGOS data that were included in the analysis:

```{r}
map.post.ARGOS <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = post.ARGOS,
             aes(x = Lon1, y = Lat1, color = ID.f),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  theme(legend.title = element_text(size = 10, hjust = 0.5),
        legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

if (save.figure)
  ggsave(filename = "figures/map_post_ARGOS.png",
         plot = map.post.ARGOS,
         device = "png",
         dpi = 600)
plot(map.post.ARGOS)
```


We have a lot more individuals from the post period than the pre, so we need to do something about that... especially for computing HRs. 


Section 3: Compute HRs

```{r}
# when trying to compute HR for each individual, some don't have enough data
# extract those with at least 50 data points:

pre.kd.GPS <- HR.analysis.step1(min_n, pre.summary$GPS, tagproj, grid = grid.value)
pre.kd.ARGOS <- HR.analysis.step1(min_n, pre.summary$ARGOS, tagproj, grid = grid.value)
```
The algorithm does not converge for ARGOS data.

Do the same with post dataset - choose those with at least min_n data points. 

```{r}
post.kd.GPS <- HR.analysis.step1(min_n, post.summary$GPS, tagproj, grid = grid.value)
post.kd.ARGOS <- HR.analysis.step1(min_n, post.summary$ARGOS, tagproj, grid = grid.value)
```

The algorithm does not converge for ARGOS data.

Then the home range analysis starts here. First we need to figure out the smoothing parameter (bandwidth, h). There seem to be different methods and recommendations...

First, least-squares cross validation on the pre data:
```{r}
plotLSCV(pre.kd.GPS$kd.LSCV)

```

Looking at the GPS data, referecne or optimum bandwidth is ~248 (see pre.kd.GPS\$kd.href@h), whereas the LSCV comes back with h = 27.5 (Pre.kd.GPS\$kd.LSCV@h). According to Kie (2013), we should decrease href in increments of 0.10 and the best value is the smallest increment of href that 1. resulted in a contiguous rather than disjoint 95% kernel home-range polygon, and 2. contained no lacuna within the home range. 

Looking at these plots, multiplier = 0.4 may be the smallest value with a contiguous 95% UD.  This is found in h.pre.1 below. 

```{r}
h.multiplier <-  seq(from = 0.1, to = 0.95, by = 0.05) 

pre.GPS <- run.HR.analysis(pre.kd.GPS, 
                           "pre_GPS", 
                           grid.value, 
                           h.multiplier, 
                           shape.file.dir = "shapefiles_Nov2019/")


plot(pre.GPS$h.adhoc$figure)

if (save.figure)
  ggsave(filename = "figures/map_pre_GPS_h_adhoc.png",
         plot = pre.GPS$h.adhoc$figure,
         device = "png",
         dpi = 600)

```



Try the same process with ARGOS data. 

```{r}
plotLSCV(pre.kd.ARGOS$kd.LSCV)

```

This doesn't look good... Yikes!

I see there is a problem in plotting because of the boundary is a bit too small... Extending the southern end of the limits in the function fixed it.  The multiplier of 0.7 makes a contiguous 95% HR. 

```{r}
pre.ARGOS <- run.HR.analysis(pre.kd.ARGOS, 
                           "pre_ARGOS", 
                           grid.value, 
                           h.multiplier, 
                           shape.file.dir = "shapefiles_Nov2019/")
plot(pre.ARGOS$h.adhoc$figure)

if (save.figure)
  ggsave(filename = "figures/map_pre_ARGOS_h_adhoc.png",
         plot = pre.ARGOS$h.adhoc$figure,
         device = "png",
         dpi = 600)
```


ARGOS data are not quite the same - h is 216! 


Do the same for the post data - here we need to look at subsampling individuals. First, use all data.

First, least-squares cross validation on the pre data:
First, least-squares cross validation on the pre data:
```{r}
plotLSCV(post.kd.GPS$kd.LSCV)

```

Looking at the GPS data, referecne or optimum bandwidth is ~255 (see post.kd.GPS\$kd.href@h), whereas the LSCV comes back with h = 34.6 (Post.kd.GPS\$kd.LSCV@h). According to Kie (2013), we should decrease href in increments of 0.10 and the best value is the smallest increment of href that 1. resulted in a contiguous rather than disjoint 95% kernel home-range polygon, and 2. contained no lacuna within the home range. 
```{r}
post.GPS <- run.HR.analysis(post.kd.GPS, 
                           "post_GPS", 
                           grid.value, 
                           h.multiplier, 
                           shape.file.dir = "shapefiles_Nov2019/")
plot(post.GPS$h.adhoc$figure)

if (save.figure)
  ggsave(filename = "figures/map_post_GPS_h_adhoc.png",
         plot = post.GPS$h.adhoc$figure,
         device = "png",
         dpi = 600)

```

Try the same process with ARGOS data:

```{r}
plotLSCV(post.kd.ARGOS$kd.LSCV)

```

This doesn't look good... Yikes!



```{r}
post.ARGOS <- run.HR.analysis(post.kd.ARGOS, 
                           "post_ARGOS", 
                           grid.value, 
                           h.multiplier, 
                           shape.file.dir = "shapefiles_Nov2019/")
plot(post.ARGOS$h.adhoc$figure)

if (save.figure)
  ggsave(filename = "figures/map_post_ARGOS_h_adhoc.png",
         plot = post.ARGOS$h.adhoc$figure,
         device = "png",
         dpi = 600)
```

The multiplier of 0.5 makes a contiguous 95% HR see h.post.1 below. 


Compare between night and day and pre and post:
```{r}
# pre day vs pre night:
pre.summary$GPS %>% filter(day1night2 == 1) -> pre.GPS.day

pre.GPS.kd.day <- HR.analysis.step1(min_n, pre.GPS.day, tagproj, grid = grid.value)

plotLSCV(pre.GPS.kd.day$kd.LSCV)
```

```{r}
pre.GPS.day <- run.HR.analysis(pre.GPS.kd.day, 
                           "pre_GPS_day", 
                           grid.value, 
                           h.multiplier, 
                           shape.file.dir = "shapefiles_Nov2019/")

plot(pre.GPS.day$h.adhoc$figure)

if (save.figure)
  ggsave(filename = "figures/map_pre_GPS_h_adhoc_day.png",
         plot = pre.GPS.day$h.adhoc$figure,
         device = "png",
         dpi = 600)

```

multiplier = 0.5 may be good. See h.pre.GPS.day.1.

For night:
```{r}
pre.summary$GPS %>% filter(day1night2 == 2) -> pre.GPS.night

pre.GPS.kd.night <- HR.analysis.step1(min_n, pre.GPS.night, tagproj, grid = grid.value)
plotLSCV(pre.GPS.kd.night$kd.LSCV)

```

```{r}
pre.GPS.night <- run.HR.analysis(pre.GPS.kd.night, 
                           "pre_GPS_night", 
                           grid.value, 
                           h.multiplier, 
                           shape.file.dir = "shapefiles_Nov2019/")

plot(pre.GPS.night$h.adhoc$figure)

if (save.figure)
  ggsave(filename = "figures/map_pre_GPS_h_adhoc_night.png",
         plot = pre.GPS.night$h.adhoc$figure,
         device = "png",
         dpi = 600)
```

multiplier = 0.55 may be good. See h.pre.night.1.

Do the same with the post period
```{r}
# pre day vs pre night:
post.summary$GPS %>% filter(day1night2 == 1) -> post.GPS.day

post.GPS.kd.day <- HR.analysis.step1(min_n, post.GPS.day, tagproj, grid = grid.value)

plotLSCV(post.GPS.kd.day$kd.LSCV)
```

```{r}
post.GPS.day <- run.HR.analysis(post.GPS.kd.day, 
                                "post_GPS_day", 
                                grid.value, 
                                h.multiplier, 
                                shape.file.dir = "shapefiles_Nov2019/")

plot(post.GPS.day$h.adhoc$figure)
if (save.figure)
  ggsave(filename = "figures/map_post_GPS_h_adhoc_day.png",
         plot = post.GPS.day$h.adhoc$figure,
         device = "png",
         dpi = 600)
```

multiplier = 0.45 may be good. See h.post.day.1. 

For night:
```{r}
post.summary$GPS %>% filter(day1night2 == 2) -> post.GPS.night
post.GPS.kd.night <- HR.analysis.step1(min_n, post.GPS.night, tagproj, grid = grid.value)
plotLSCV(post.GPS.kd.night$kd.LSCV)

```

```{r}
post.GPS.night <- run.HR.analysis(post.GPS.kd.night, 
                                "post_GPS_night", 
                                grid.value, 
                                h.multiplier, 
                                shape.file.dir = "shapefiles_Nov2019/")

plot(post.GPS.night$h.adhoc$figure)
if (save.figure)
  ggsave(filename = "figures/map_post_GPS_h_adhoc_night.png",
         plot = post.GPS.night$h.adhoc$figure,
         device = "png",
         dpi = 600)
```

multiplier = 0.6 may be good. See h.post.night.1. 

With ARGOS data
```{r}
post.summary$ARGOS %>% filter(day1night2 == 1) -> post.ARGOS.day

post.ARGOS.kd.day <- HR.analysis.step1(min_n, post.ARGOS.day, tagproj, grid = grid.value)

plotLSCV(post.ARGOS.kd.day$kd.LSCV)
```

```{r}
post.ARGOS.day <- run.HR.analysis(post.ARGOS.kd.day, 
                                "post_ARGOS_day", 
                                grid.value, 
                                h.multiplier, 
                                shape.file.dir = "shapefiles_Nov2019/")

plot(post.ARGOS.day$h.adhoc$figure)
if (save.figure)
  ggsave(filename = "figures/map_post_ARGOS_h_adhoc_day.png",
         plot = post.ARGOS.day$h.adhoc$figure,
         device = "png",
         dpi = 600)
```

multiplier = 0.45 may be good. See h.post.day.1. 

For night:
```{r}
post.summary$ARGOS %>% filter(day1night2 == 2) -> post.ARGOS.night
post.ARGOS.kd.night <- HR.analysis.step1(min_n, post.ARGOS.night, tagproj, grid = grid.value)
plotLSCV(post.ARGOS.kd.night$kd.LSCV)

```

```{r}
post.ARGOS.night <- run.HR.analysis(post.ARGOS.kd.night, 
                                "post_ARGOS_night", 
                                grid.value, 
                                h.multiplier, 
                                shape.file.dir = "shapefiles_Nov2019/")

plot(post.ARGOS.night$h.adhoc$figure)
if (save.figure)
  ggsave(filename = "figures/map_post_ARGOS_h_adhoc_night.png",
         plot = post.ARGOS.night$h.adhoc$figure,
         device = "png",
         dpi = 600)
```



Extract UDs for each individual. Starting with pre:
```{r message=FALSE}
pre.HR.byID <- data.frame(ID = pre.kd$list.data$unique.ID,
                          Area.50 = t(as.matrix(pre.HR$area.byID.50)),
                          Area.95 = t(as.matrix(pre.HR$area.byID.95))) 

h.multip.pre.eachID <- h.pre.eachID <- vector(mode = "numeric", 
                                              length = length(pre.kd$list.data$eachID.utm))

UD.95.pre.eachID <- UD.50.pre.eachID <- vector(mode = "list", 
                                               length = length(pre.kd$list.data$eachID.utm))
for (k in 1:length(pre.kd$list.data$eachID.utm)){
  
  dat.utm <- pre.kd$list.data$eachID.utm[[k]]
  best.h <- find.h.adhoc(dat.utm)
  h.pre.eachID[k] <- round(best.h$h)
  h.multip.pre.eachID[k] <- best.h$h.multip
  UD <- kernelUD(dat.utm, h = h.pre.eachID[k], 
                 kern = "bivnorm", grid = grid.value)
  UD.95.pre.eachID[[k]] <- getverticeshr(UD, 95)
  UD.50.pre.eachID[[k]] <- getverticeshr(UD, 50)
}

# day data
pre.day.HR.byID <- data.frame(ID = pre.kd.day$list.data$unique.ID,
                              Area.50 = t(as.matrix(pre.HR.day$area.byID.50)),
                              Area.95 = t(as.matrix(pre.HR.day$area.byID.95))) 

h.multip.pre.day.eachID <- h.pre.day.eachID <- vector(mode = "numeric", 
                           length = length(pre.kd.day$list.data$eachID.utm))

UD.95.pre.day.eachID <- UD.50.pre.day.eachID <- vector(mode = "list", 
                           length = length(pre.kd.day$list.data$eachID.utm))
for (k in 1:length(pre.kd.day$list.data$eachID.utm)){
  # day:
  dat.utm <- pre.kd.day$list.data$eachID.utm[[k]]
  best.h <- find.h.adhoc(dat.utm)
  h.pre.day.eachID[k] <- round(best.h$h)
  h.multip.pre.day.eachID[k] <- best.h$h.multip
  UD <- kernelUD(dat.utm, h = h.pre.day.eachID[k], 
                 kern = "bivnorm", grid = grid.value)
  UD.95.pre.day.eachID[[k]] <- getverticeshr(UD, 95)
  UD.50.pre.day.eachID[[k]] <- getverticeshr(UD, 50)
}

# night data
h.multip.pre.night.eachID <- h.pre.night.eachID <- vector(mode = "numeric", 
                           length = length(pre.kd.night$list.data$eachID.utm))

UD.95.pre.night.eachID <- UD.50.pre.night.eachID <- vector(mode = "list", 
                           length = length(pre.kd.night$list.data$eachID.utm))

for (k in 1:length(pre.kd.night$list.data$eachID.utm)){
  # night:
  dat.utm <- pre.kd.night$list.data$eachID.utm[[k]]
  best.h <- find.h.adhoc(dat.utm)
  h.pre.night.eachID[k] <- round(best.h$h)
  h.multip.pre.night.eachID[k] <- best.h$h.multip
  UD <- kernelUD(dat.utm, h = h.pre.night.eachID[k], 
                 kern = "bivnorm", grid = grid.value)
  UD.95.pre.night.eachID[[k]] <- getverticeshr(UD, 95)
  UD.50.pre.night.eachID[[k]] <- getverticeshr(UD, 50)
  
}

tmp.pre.95 <- lapply(UD.95.pre.eachID, 
                     FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))

tmp.pre.50 <- lapply(UD.50.pre.eachID, 
                     FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))

tmp.pre.day.95 <- lapply(UD.95.pre.day.eachID, 
                         FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))
tmp.pre.day.50 <- lapply(UD.50.pre.day.eachID, 
                         FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))

tmp.pre.night.95 <- lapply(UD.95.pre.night.eachID, 
                           FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))
tmp.pre.night.50 <- lapply(UD.50.pre.night.eachID, 
                           FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))

for (k in 1:length(tmp.pre.95)){
  tmp.pre.50[[k]] <- mutate(tmp.pre.50[[k]], 
                            ID = pre.kd$list.data$unique.ID[k])
  tmp.pre.95[[k]] <- mutate(tmp.pre.95[[k]], 
                            ID = pre.kd$list.data$unique.ID[k])
}

pre.eachID.ver.95.df <- do.call("rbind", tmp.pre.95)
pre.eachID.ver.50.df <- do.call("rbind", tmp.pre.50)

for (k in 1:length(tmp.pre.day.95)){
  tmp.pre.day.50[[k]] <- mutate(tmp.pre.day.50[[k]], 
                                ID = pre.kd.day$list.data$unique.ID[k])
  tmp.pre.day.95[[k]] <- mutate(tmp.pre.day.95[[k]], 
                                ID = pre.kd.day$list.data$unique.ID[k])
}

pre.day.eachID.ver.95.df <- do.call("rbind", tmp.pre.day.95)
pre.day.eachID.ver.50.df <- do.call("rbind", tmp.pre.day.50)

for (k in 1:length(tmp.pre.night.95)){
  tmp.pre.night.50[[k]] <- mutate(tmp.pre.night.50[[k]], 
                                  ID = pre.kd.night$list.data$unique.ID[k])
  tmp.pre.night.95[[k]] <- mutate(tmp.pre.night.95[[k]], 
                                  ID = pre.kd.night$list.data$unique.ID[k])
}

pre.day.eachID.ver.95.df <- do.call("rbind", tmp.pre.day.95)
pre.day.eachID.ver.50.df <- do.call("rbind", tmp.pre.day.50)

```

Now for post:
```{r message=FALSE}
h.post.eachID <- h.multip.post.eachID <- vector()
UD.95.post.eachID <- UD.50.post.eachID <- list()

h.post.night.eachID <- h.multip.post.night.eachID <- vector()
UD.95.post.night.eachID <- UD.50.post.night.eachID <- list()

h.post.day.eachID <- h.multip.post.day.eachID <- vector()
UD.95.post.day.eachID <- UD.50.post.day.eachID <- list()

# first find appropriate bandwidth for each individual:
for (k in 1:length(post.kd$list.data$eachID.utm)){
  dat.utm <- post.kd$list.data$eachID.utm[[k]]
  best.h <- find.h.adhoc(dat.utm)
  h.post.eachID[k] <- round(best.h$h)
  h.multip.post.eachID[k] <- best.h$h.multip
  UD <- kernelUD(dat.utm, h = h.post.eachID[k], 
                 kern = "bivnorm", 
                 grid = grid.value)
  UD.95.post.eachID[[k]] <- getverticeshr(UD, 95)
  UD.50.post.eachID[[k]] <- getverticeshr(UD, 50)
}

for (k in 1:length(post.kd.day$list.data$eachID.utm)){
  # day:
  dat.utm <- post.kd.day$list.data$eachID.utm[[k]]
  best.h <- find.h.adhoc(dat.utm)
  h.post.day.eachID[k] <- round(best.h$h)
  h.multip.post.day.eachID[k] <- best.h$h.multip
  UD <- kernelUD(dat.utm, h = h.post.day.eachID[k], 
                 kern = "bivnorm", grid = grid.value)
  UD.95.post.day.eachID[[k]] <- getverticeshr(UD, 95)
  UD.50.post.day.eachID[[k]] <- getverticeshr(UD, 50)
}

for (k in 1:length(post.kd.night$list.data$eachID.utm)){
  # night:
  dat.utm <- post.kd.night$list.data$eachID.utm[[k]]
  best.h <- find.h.adhoc(dat.utm)
  h.post.night.eachID[k] <- round(best.h$h)
  h.multip.post.night.eachID[k] <- best.h$h.multip
  UD <- kernelUD(dat.utm, h = h.post.night.eachID[k], 
                 kern = "bivnorm", grid = grid.value)
  UD.95.post.night.eachID[[k]] <- getverticeshr(UD, 95)
  UD.50.post.night.eachID[[k]] <- getverticeshr(UD, 50)
  
}

tmp.post.95 <- lapply(UD.95.post.eachID, 
                 FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))
tmp.post.50 <- lapply(UD.50.post.eachID, 
                 FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))

tmp.post.day.95 <- lapply(UD.95.post.day.eachID, 
                         FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))
tmp.post.day.50 <- lapply(UD.50.post.day.eachID, 
                         FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))

tmp.post.night.95 <- lapply(UD.95.post.night.eachID, 
                           FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))
tmp.post.night.50 <- lapply(UD.50.post.night.eachID, 
                           FUN = function(x) broom::tidy(spTransform(x, CRS("+proj=longlat"))))


for (k in 1:length(tmp.post.95)){
  tmp.post.50[[k]] <- mutate(tmp.post.50[[k]], 
                             ID = post.kd$list.data$unique.ID[k])
  tmp.post.95[[k]] <- mutate(tmp.post.95[[k]], 
                             ID = post.kd$list.data$unique.ID[k])
}

post.eachID.ver.95.df <- do.call("rbind", tmp.post.95) 
post.eachID.ver.50.df <- do.call("rbind", tmp.post.50)

for (k in 1:length(tmp.post.day.95)){
  tmp.post.day.50[[k]] <- mutate(tmp.post.day.50[[k]], 
                                 ID = post.kd.day$list.data$unique.ID[k])
  tmp.post.day.95[[k]] <- mutate(tmp.post.day.95[[k]], 
                                 ID = post.kd.day$list.data$unique.ID[k])
}

post.day.eachID.ver.95.df <- do.call("rbind", tmp.post.day.95)
post.day.eachID.ver.50.df <- do.call("rbind", tmp.post.day.50)

for (k in 1:length(tmp.post.night.95)){
  tmp.post.night.50[[k]] <- mutate(tmp.post.night.50[[k]], 
                                   ID = post.kd.night$list.data$unique.ID[k])
  tmp.post.night.95[[k]] <- mutate(tmp.post.night.95[[k]], 
                                   ID = post.kd.night$list.data$unique.ID[k])
}

post.day.eachID.ver.95.df <- do.call("rbind", tmp.post.day.95)
post.day.eachID.ver.50.df <- do.call("rbind", tmp.post.day.50)

```

Bring in the body size information. This was done in deployment_table.R script and manually modified for missing data - some measurements were not collected when the tags were deployed so data from the closest captures were used.  Data were entered manually for three turtles in the Excel file: 52675 (all measurements) from 2007-01-23, 44366 (SCL and CCL) from 2009-02-26, and 126065 (Mass) from 2011-03-08).   
```{r}
dat.table <- read.csv("data/all_sample_summary_size_2018-07-24.csv")

pre.areas.95 <- unlist(lapply(lapply(UD.95.pre.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))
pre.areas.50 <- unlist(lapply(lapply(UD.50.pre.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))

pre.day.areas.95 <- unlist(lapply(lapply(UD.95.pre.day.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))
pre.day.areas.50 <- unlist(lapply(lapply(UD.50.pre.day.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))

pre.night.areas.95 <- unlist(lapply(lapply(UD.95.pre.night.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))
pre.night.areas.50 <- unlist(lapply(lapply(UD.50.pre.night.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))

pre.areas.df <- data.frame(ID.f = pre.kd$list.data$unique.ID,
                           area.50 = pre.areas.50/1000000,
                           area.95 = pre.areas.95/1000000)

pre.day.areas.df <- data.frame(ID.f = pre.kd.day$list.data$unique.ID,
                               area.day.50 = pre.day.areas.50/1000000,
                               area.day.95 = pre.day.areas.95/1000000)

pre.night.areas.df <- data.frame(ID.f = pre.kd.night$list.data$unique.ID,
                           area.night.50 = pre.night.areas.50/1000000,
                           area.night.95 = pre.night.areas.95/1000000)

post.areas.95 <- unlist(lapply(lapply(UD.95.post.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))
post.areas.50 <- unlist(lapply(lapply(UD.50.post.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))

post.day.areas.95 <- unlist(lapply(lapply(UD.95.post.day.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))
post.day.areas.50 <- unlist(lapply(lapply(UD.50.post.day.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))

post.night.areas.95 <- unlist(lapply(lapply(UD.95.post.night.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))
post.night.areas.50 <- unlist(lapply(lapply(UD.50.post.night.eachID, 
                                      FUN = extract.areas),
                               FUN = function(x) x$total.area))

post.areas.df <- data.frame(ID.f = post.kd$list.data$unique.ID,
                           area.50 = post.areas.50/1000000,
                           area.95 = post.areas.95/1000000)

post.day.areas.df <- data.frame(ID.f = post.kd.day$list.data$unique.ID,
                           area.day.50 = post.day.areas.50/1000000,
                           area.day.95 = post.day.areas.95/1000000)

post.night.areas.df <- data.frame(ID.f = post.kd.night$list.data$unique.ID,
                           area.night.50 = post.night.areas.50/1000000,
                           area.night.95 = post.night.areas.95/1000000)

areas.df <- rbind(pre.areas.df, post.areas.df)
areas.night.df <- rbind(pre.night.areas.df, post.night.areas.df)
areas.day.df <- rbind(pre.day.areas.df, post.day.areas.df)

dat.table <- left_join(dat.table, areas.df, by = "ID.f") %>%
  left_join(., areas.night.df, by = "ID.f") %>%
  left_join(., areas.day.df, by = "ID.f")

write.csv(dat.table, file = paste0("data/IDvsUDs_",
                                   Sys.Date(), ".csv"), 
          quote = F, row.names = F)

ggplot(data = dat.table) +
  geom_point(aes(x = Mass_kg, 
                 y = area.50/1000000,
                 color = period)) 
```

Plotting starts here:
Make a plot for pre using all data:
```{r}

pre.ver.50.df <- broom::tidy(spTransform(pre.HR$ver.50, CRS("+proj=longlat")))
pre.ver.95.df <- broom::tidy(spTransform(pre.HR$ver.95, CRS("+proj=longlat")))

map.pre.HR <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_polygon(data = pre.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "cornsilk",
               alpha = 0.6) + 
  geom_polygon(data = pre.ver.50.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  # geom_point(data = pre.all,
  #            aes(x = Lon1, y = Lat1),
  #            alpha = 0.5,
  #            size = 0.2)+ 
  # geom_polygon(data = water.df,
  #              aes(x = long,
  #                  y = lat,
  #                  group = group),
  #              fill = "blue",
  #              alpha = 0.2) +

  #coord_map() + 
  #labs(color = 'ARGOS ID') + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")


plot(map.pre.HR)
```

Make a plot for pre day:
```{r}

pre.day.ver.50.df <- broom::tidy(spTransform(pre.HR.day$ver.50, CRS("+proj=longlat")))
pre.day.ver.95.df <- broom::tidy(spTransform(pre.HR.day$ver.95, CRS("+proj=longlat")))

map.pre.day.HR <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_polygon(data = pre.day.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "cornsilk",
               alpha = 0.6) + 
  geom_polygon(data = pre.day.ver.50.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  # geom_point(data = pre.all,
  #            aes(x = Lon1, y = Lat1),
  #            alpha = 0.5,
  #            size = 0.2)+ 
  # geom_polygon(data = water.df,
  #              aes(x = long,
  #                  y = lat,
  #                  group = group),
  #              fill = "blue",
  #              alpha = 0.2) +

  #coord_map() + 
  #labs(color = 'ARGOS ID') + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")


plot(map.pre.day.HR)
```

Make a plot for pre night:
```{r}

pre.night.ver.50.df <- broom::tidy(spTransform(pre.HR.night$ver.50, 
                                               CRS("+proj=longlat")))

pre.night.ver.95.df <- broom::tidy(spTransform(pre.HR.night$ver.95, 
                                               CRS("+proj=longlat")))

map.pre.night.HR <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_polygon(data = pre.night.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "cornsilk",
               alpha = 0.6) + 
  geom_polygon(data = pre.night.ver.50.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  # geom_point(data = pre.all,
  #            aes(x = Lon1, y = Lat1),
  #            alpha = 0.5,
  #            size = 0.2)+ 
  # geom_polygon(data = water.df,
  #              aes(x = long,
  #                  y = lat,
  #                  group = group),
  #              fill = "blue",
  #              alpha = 0.2) +

  #coord_map() + 
  #labs(color = 'ARGOS ID') + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")


plot(map.pre.night.HR)
```

Make a plot for post using all data:
```{r}

post.ver.50.df <- broom::tidy(spTransform(post.HR$ver.50, CRS("+proj=longlat")))
post.ver.95.df <- broom::tidy(spTransform(post.HR$ver.95, CRS("+proj=longlat")))

map.post.HR <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2014.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_polygon(data = post.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "cornsilk",
               alpha = 0.6) + 
  geom_polygon(data = post.ver.50.df,
               aes(x = long, y = lat, 
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  # geom_point(data = post.all,
  #            aes(x = Lon1, y = Lat1),
  #            alpha = 0.5,
  #            size = 0.2)+ 
  # # geom_polygon(data = water.df,
  #              aes(x = long,
  #                  y = lat,
  #                  group = group),
  #              fill = "blue",
  #              alpha = 0.2) +

  #coord_map() + 
  #labs(color = 'ARGOS ID') + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")
plot(map.post.HR)
```

Make a plot for post day:
```{r}

post.day.ver.50.df <- broom::tidy(spTransform(post.HR.day$ver.50, CRS("+proj=longlat")))
post.day.ver.95.df <- broom::tidy(spTransform(post.HR.day$ver.95, CRS("+proj=longlat")))

map.post.day.HR <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2014.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_polygon(data = post.day.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "cornsilk",
               alpha = 0.6) + 
  geom_polygon(data = post.day.ver.50.df,
               aes(x = long, y = lat, 
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  # geom_point(data = post.all,
  #            aes(x = Lon1, y = Lat1),
  #            alpha = 0.5,
  #            size = 0.2)+ 
  # # geom_polygon(data = water.df,
  #              aes(x = long,
  #                  y = lat,
  #                  group = group),
  #              fill = "blue",
  #              alpha = 0.2) +

  #coord_map() + 
  #labs(color = 'ARGOS ID') + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

plot(map.post.day.HR)
```


Make a plot for post night:
```{r}

post.night.ver.50.df <- broom::tidy(spTransform(post.HR.night$ver.50,
                                                CRS("+proj=longlat")))
post.night.ver.95.df <- broom::tidy(spTransform(post.HR.night$ver.95,
                                                CRS("+proj=longlat")))

map.post.night.HR <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2014.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_polygon(data = post.night.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "cornsilk",
               alpha = 0.6) + 
  geom_polygon(data = post.night.ver.50.df,
               aes(x = long, y = lat, 
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  xlab('Longitude') + ylab('Latitude') + 
  theme(#legend.title = element_text(size = 10, hjust = 0.5),
        #legend.text = element_text(size = 8, vjust = 0),
        legend.position = "none")

plot(map.post.night.HR)
```

Simple plots with day/night for the pre:
Plot the data points to see what they look like:

```{r}
map.pre.day.night <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = pre.all,
             aes(x = Lon1, y = Lat1, 
                 color = as.factor(day1night2)),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  scale_color_discrete(labels = c("Day", "Night"),
                       name = NULL) 

  theme(legend.title = NULL,
        legend.text = element_text(size = 8, vjust = 0))
        #legend.position = "none")

plot(map.pre.day.night)

```

```{r}
map.post.day.night <- map.sdbay.zm + 
  geom_polygon(data = SDBay.df,
               aes(x = long, y = lat)) +
               #fill = "blue",alpha = 0.6) + 
  geom_polygon(data = SDBay.eelg.2008.df,
               aes(x = long,
                   y = lat,
                   group = group),
               fill = "green",
               alpha = 0.5) +
  geom_point(data = post.all,
             aes(x = Lon1, y = Lat1, 
                 color = as.factor(day1night2)),
             alpha = 0.5)+ 
  xlab('Longitude') + ylab('Latitude') + 
  scale_color_discrete(labels = c("Day", "Night"),
                       name = NULL) 

plot(map.post.day.night)

```


UDs for individual turtles:
```{r}

p.h.pre.eachID <- ggplot() + 
  geom_polygon(data = pre.eachID.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "aquamarine4",
               alpha = 0.6) + 
  geom_polygon(data = pre.eachID.ver.50.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "red3",
               alpha = 0.6) +
  coord_map() + 
  facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 2) + 
  labs(x = "", y = "")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(-117.14, -117.12, -117.10),
                     limits = c(-117.15, -117.09)) +
  scale_y_continuous(breaks = c(32.60, 32.62, 32.64),
                     limits = c(32.59, 32.65))
plot(p.h.pre.eachID)
```

```{r}

p.h.post.eachID <- ggplot() + 
  geom_polygon(data = post.eachID.ver.95.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "aquamarine4",
               alpha = 0.6) + 
  geom_polygon(data = post.eachID.ver.50.df,
               aes(x = long, y = lat,
                   group = group),
               fill = "red3",
               alpha = 0.6) + 
  coord_map() + facet_grid(. ~ ID) +
  facet_wrap( ~ ID, nrow = 3) + 
  labs(x = "", y = "")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) #+
  #scale_x_continuous(breaks = seq(from = -117.18, to = -117.08, by = 0.02),
  #                   limits = c(-117.20, -117.06)) +
  #scale_y_continuous(breaks = seq(from = 32.57, to = 32.67, by = 0.02),
  #                   limits = c(32.56, 32.68))
plot(p.h.post.eachID)
```



Save figures:
```{r}
if (save.figure){
  ggsave(filename = paste0("figures/HR_pre_h_comp_", Sys.Date(), ".png"),
       plot = h.adhoc.pre$figure,
       dpi = 600,
       device = "png")
  ggsave(filename = paste0("figures/HR_post_h_comp_", Sys.Date(), ".png"),
         plot = h.adhoc.post$figure,
         dpi = 600,
         device = "png")
  ggsave(filename = paste0("figures/HR_pre_day_h_comp_", Sys.Date(), ".png"),
         plot = h.adhoc.pre.day$figure,
         dpi = 600,
         device = "png")
  ggsave(filename = paste0("figures/HR_pre_night_h_comp_", Sys.Date(), ".png"),
         plot = h.adhoc.pre.night$figure,
         dpi = 600,
         device = "png")
  ggsave(filename = paste0("figures/HR_post_day_h_comp_", Sys.Date(), ".png"),
         plot = h.adhoc.post.day$figure,
         dpi = 600,
         device = "png")
  ggsave(filename = paste0("figures/HR_post_night_h_comp_", Sys.Date(), ".png"),
         plot = h.adhoc.post.night$figure,
         dpi = 600,
         device = "png")
  ggsave(filename = paste0("figures/HR_pre_h_", h.pre, "_", Sys.Date(), ".png"),
         plot = map.pre.HR,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HR_post_h_", h.post, "_", Sys.Date(), ".png"),
         plot = map.post.HR,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HR_pre_day_h_", 
                           h.pre.day, "_", Sys.Date(), ".png"),
         plot = map.pre.day.HR,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HR_post_day_h_", 
                           h.post.day, "_", Sys.Date(), ".png"),
         plot = map.post.day.HR,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HR_pre_night_h_", 
                           h.pre.night, "_", Sys.Date(), ".png"),
         plot = map.pre.night.HR,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HR_post_night_h_", 
                           h.post.night, "_", Sys.Date(), ".png"),
         plot = map.post.night.HR,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HR50_difference_", 
                           Sys.Date(), ".png"),
         plot = hist.dif.50,
         dpi = 600,
         device = "png")
  
  ggsave(filename = paste0("figures/HRbyID_pre_",
                           Sys.Date(), ".png"),
         plot = p.h.pre.eachID,
         dpi = 600,
         device = "png")
  ggsave(filename = paste0("figures/HRbyID_post_",
                           Sys.Date(), ".png"),
         plot = p.h.post.eachID,
         dpi = 600,
         device = "png")
}

save(list = ls(),
     file = paste0("RData/output_HR_analysis_", Sys.Date(), ".RData"))
#plot(map.post.HR)
```